<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CACHE DISABLE FIX -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Inventory Report Editor</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    padding:20px;
    background:#f4f4f4;
}

.container{
    max-width:1000px;
    margin:auto;
    background:#fff;
    padding:20px;
}

h2{
    text-align:center;
    font-size:22px;
    text-transform:uppercase;
    margin-bottom:20px;
}

table{
    width:100%;
    border-collapse:collapse;
}

th,td{
    border:2px solid #000;
    padding:10px;
}

th{
    background:#9fb6cc;
    text-align:center;
}

.device-col{
    width:150px;
    text-align:center;
}

.device-col input{
    width:100%;
    text-align:center;
    font-weight:bold;
    font-size:18px;
}

/* Remove arrows */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{
    -webkit-appearance:none;
    margin:0;
}
input[type=number]{
    -moz-appearance:textfield;
}

.action-col{
    width:90px;
    text-align:center;
}

input{
    width:100%;
    border:none;
    font-size:15px;
    outline:none;
    background:transparent;
}

.total-row td{
    font-weight:bold;
    font-size:18px;
    background:#e5e5e5;
}

button{
    padding:6px 10px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    color:white;
    font-weight:bold;
}

.btn-insert{ background:#28a745; }
.btn-delete{ background:#dc3545; }
.btn-save{ background:#007bff; }
.btn-reset{ background:#6c757d; }

.controls{
    text-align:center;
    margin-top:20px;
}

.exporting .action-col{
    display:none;
}
</style>
</head>

<body>

<div class="container" id="report-area">
<h2 id="report-title"></h2>

<table>
<thead>
<tr>
<th>DETAILS</th>
<th class="device-col">DEVICE</th>
<th class="action-col">ACTION</th>
</tr>
</thead>

<tbody id="inventory-body"></tbody>

<tfoot>
<tr class="total-row">
<td>Total Sum of Telematics</td>
<td id="total-sum" class="device-col">0</td>
<td class="action-col"></td>
</tr>
</tfoot>
</table>
</div>

<div class="controls">
<button class="btn-save" onclick="exportToJPG()">Save as JPG</button>
<button class="btn-reset" onclick="clearData()">Clear Cache</button>
</div>

<script>

/* ===== ALWAYS FRESH DATE ===== */
function setAutoTitle(){
    const now = new Date();
    const day = String(now.getDate()).padStart(2,'0');
    const month = String(now.getMonth()+1).padStart(2,'0');
    const year = now.getFullYear();

    const hours = now.getHours();
    let shift = hours>=6 && hours<14 ? "A-SHIFT" :
                hours>=14 && hours<22 ? "B-SHIFT" : "C-SHIFT";

    document.getElementById("report-title").innerText =
    `INVENTORY REPORT AS ON DTD:-${day}-${month}-${year} ${shift}`;
}

/* ===== STANDARD ROWS ===== */
const standardRows = [
"In hand stock",
"Lost device",
"Damaged Device",
"Devices in transit",
"Devices received at Barbil Plant",
"Stock devices in Gandhamardhan",
"Stock devices in Guali",
"Stock devices in Jilling",
"Stock devices in Khandbandh",
"Stock devices in Unchabali"
];

/* ===== CREATE ROW ===== */
function createRow(text="", value=0){
    const row = document.createElement("tr");
    row.innerHTML = `
        <td><input type="text" value="${text}" oninput="saveData()"></td>
        <td class="device-col">
            <input type="number" class="count" value="${value}" min="0"
            oninput="calculateTotal(); saveData()">
        </td>
        <td class="action-col">
            <button class="btn-insert" onclick="insertRow(this)">+</button>
            <button class="btn-delete" onclick="deleteRow(this)">Ã—</button>
        </td>
    `;
    return row;
}

/* ===== INSERT DELETE ===== */
function insertRow(btn){
    btn.closest("tr").after(createRow(""));
    saveData();
}

function deleteRow(btn){
    btn.closest("tr").remove();
    calculateTotal();
    saveData();
}

/* ===== TOTAL ===== */
function calculateTotal(){
    let total = 0;
    document.querySelectorAll(".count").forEach(inp=>{
        total += parseInt(inp.value) || 0;
    });
    document.getElementById("total-sum").innerText = total;
}

/* ===== SAVE ===== */
function saveData(){
    const rows = [];
    document.querySelectorAll("#inventory-body tr").forEach(row=>{
        const text = row.querySelector("td input[type=text]").value;
        const value = row.querySelector(".count").value;
        rows.push({text,value});
    });
    localStorage.setItem("inventoryData", JSON.stringify(rows));
}

/* ===== LOAD ===== */
function loadData(){
    setAutoTitle(); // ALWAYS update date fresh

    const saved = localStorage.getItem("inventoryData");
    const tbody = document.getElementById("inventory-body");
    tbody.innerHTML = "";

    if(saved){
        JSON.parse(saved).forEach(r=>{
            tbody.appendChild(createRow(r.text, r.value));
        });
    } else {
        standardRows.forEach(text=>{
            tbody.appendChild(createRow(text,0));
        });
    }

    calculateTotal();
}

/* ===== CLEAR CACHE ===== */
function clearData(){
    if(confirm("Clear saved inventory data?")){
        localStorage.removeItem("inventoryData");
        location.reload(true);
    }
}

/* ===== EXPORT ===== */
function exportToJPG(){
    const element = document.getElementById("report-area");
    element.classList.add("exporting");

    html2canvas(element,{ scale:3 }).then(canvas=>{
        const link = document.createElement("a");
        link.download = "Inventory_Report.jpg";
        link.href = canvas.toDataURL("image/jpeg",1.0);
        link.click();
        element.classList.remove("exporting");
    });
}

window.onload = loadData;

</script>

</body>
</html>
